local startingPos = vector3(-1051.0393066406,6.0683135986328,50.631088256836)

local cfg = {
    slots = {
        {
            {-1111.8394775391,72.270378112793,52.73461151123},
            {-1107.9979248047,67.639724731445,52.092620849609},
            {-1105.7512207031,71.001892089844,52.266777038574},
            {-1107.8725585938,74.778785705566,52.462265014648},
            {-1114.5261230469,70.661499023438,52.850212097168},
            {-1114.7095947266,65.855438232422,52.687519073486},
            {-1112.4935302734,57.848690032959,51.726459503174},
            {-1106.9007568359,57.583515167236,51.198535919189},
            {-1101.0155029297,58.719966888428,51.296790313721},
            {-1096.130859375,62.886890411377,51.745670318604},
            {-1097.5944824219,68.385879516602,52.017383575439},
            {-1111.9296875,67.679756164551,52.344924926758},
            {-1109.7060546875,68.837036132812,52.297927856445},
            {-1109.4333496094,71.877883911133,52.555015563965},
            {-1111.0874023438,73.465065002441,52.768562316895},
            {-1104.2712402344,58.591995239258,51.154678344727},
            {-1105.4478759766,53.054584503174,50.83810043335},
            {-1112.0395507812,68.619117736816,52.434196472168},
        },
        {
            {-1038.3100585938,59.130084991455,49.574757385254},
            {-1035.2993164062,58.82262802124,49.55212097168},
            {-1033.8251953125,56.254276275635,49.418614196777},
            {-1032.2683105469,53.907409667969,49.259041595459},
            {-1030.1726074219,54.775085449219,49.23018951416},
            {-1028.7065429688,59.157257080078,49.621081542969},
            {-1031.1214599609,60.986721038818,49.696364593506},
            {-1034.1583251953,62.75919342041,49.707850646973},
            {-1039.6483154297,63.047462463379,49.624537658691},
            {-1042.2188720703,60.452865600586,49.391020965576},
            {-1044.1652832031,56.662891387939,49.230534362793},
            {-1042.1158447266,51.367874145508,49.25721282959},
            {-1047.3432617188,56.733142852783,49.223816680908},
            {-1054.4436035156,56.235950469971,49.269078063965},
            {-1044.9267578125,72.30394744873,49.982926177979},
            {-1049.0600585938,73.611846923828,49.989046478271},
            {-1048.7806396484,79.569351196289,50.333476257324},
            {-1054.9425048828,79.303207397461,50.248097229004},
        },
        {
            {-1144.2915039062,0.55520868301392,47.389284515381},
            {-1143.86328125,-4.1336221694946,47.145887756348},
            {-1140.2078857422,-2.7209980487823,47.382261657715},
            {-1149.1361083984,1.4837340116501,47.271692657471},
            {-1151.3394775391,6.6625561714172,47.502443695068},
            {-1158.7529296875,11.111824989319,47.992792510986},
            {-1157.2687988281,15.732803344727,48.280790710449},
            {-1154.8273925781,19.162107467651,48.743246459961},
            {-1154.7348632812,22.739566802979,48.942850494385},
            {-1152.1595458984,22.226884841919,48.760948944092},
            {-1149.6479492188,20.612447738647,48.631342315674},
            {-1144.2294921875,18.865047454834,47.728330993652},
            {-1138.0208740234,12.111647605896,47.709490203857},
            {-1135.3590087891,12.205837249756,47.774328613281},
            {-1134.5074462891,14.003889083862,47.901575469971},
            {-1162.373046875,-11.256433486938,45.522463226318},
            {-1164.5463867188,-15.473893165588,45.00302734375},
            {-1168.3176269531,-13.530508995056,45.154283905029},
            {-1164.1029052734,-12.158526420593,45.356672668457},
            {-1161.7718505859,-16.421363830566,44.985941314697},
            {-1168.6154785156,-20.51505279541,44.456674957275},
            {-1184.8311767578,11.238068580627,47.626406097412},
            {-1181.1567382812,15.162178039551,48.141981506348},
            {-1186.2834472656,17.749917984009,48.124266815186},
            {-1186.0709228516,20.903350830078,48.615396881104},
            {-1183.25390625,12.176993370056,47.798712158203},
        }
    },
    rocksPos = {
        { -- slot 1
            {-1122.1275634766,57.034942626953,53.483150482178},
            {-1121.4718017578,59.523319244385,53.481357574463},
            {-1119.4483642578,57.418575286865,53.388637542725},
            {-1122.7169189453,60.53621673584,53.820384979248},
            {-1120.5985107422,63.689933776855,53.485858917236},
            {-1122.1883544922,67.112213134766,53.950801849365},
            {-1125.7364501953,67.077392578125,54.083320617676},
            {-1128.8935546875,65.651748657227,54.107238769531},
        },
        { -- slot 2
            {-1047.6203613281,85.597007751465,51.437446594238},
            {-1042.0346679688,83.588272094727,51.385227203369},
            {-1037.1727294922,78.478546142578,51.268650054932},
            {-1033.6398925781,73.768432617188,51.087394714355},
            {-1031.90625,48.877246856689,49.427978515625},
            {-1026.7124023438,49.505626678467,49.938076019287},
        },
        { -- slot 3
            {-1178.7698974609,2.1641020774841,47.333595275879},
            {-1184.6617431641,0.60002261400223,46.678829193115},
            {-1180.8720703125,-3.6704459190369,46.808666229248},
            {-1168.5982666016,0.15885458886623,47.250522613525},
            {-1158.3381347656,4.2834515571594,47.55797958374},
            {-1153.8887939453,0.67481029033661,47.336536407471},
        }
    }
}

local theJob = {}

Citizen.CreateThread(function()

    local blip = AddBlipForCoord(startingPos)
    SetBlipSprite(blip, 559)
    SetBlipColour(blip, 11)
    SetBlipScale(blip, 0.6)
    SetBlipAsShortRange(blip, true)
    BeginTextCommandSetBlipName("STRING")
    AddTextComponentString("Taietor de iarba")
    EndTextCommandSetBlipName(blip)

    local pedId = vRP.spawnNpc("LawnmowerStarter", {
        position = startingPos,
        rotation = 260,
        model = "s_m_y_armymech_01",
        freeze = true,
        minDist = 2.5,        
        name = "Gabriel Ingrijitorul",
        ["function"] = function()
            SendNUIMessage({job = "lawnmower", group = inJob})
        end
    })

    table.insert(allJobPeds, "LawnmowerStarter")

end)

local vehSpawnPoint = {-1053.6164550781,-7.8844938278198,50.277153015137}


local gameFinish
RegisterNUICallback("lawnmower:gameDone", function(data, cb)
    if type(gameFinish) == "function" then
        gameFinish()
    end
    gameFinish = false
    
    cb("ok")
end)

local blips, objs = {}, {}

local mowerObj
RegisterNetEvent("work-lawnmower:startJob", function(cpData)
    if inJob == "Taietor de iarba" then
        local jobActive = true
        local evt
        
        evt = AddEventHandler("jobs:onJustFired", function()
            Citizen.Wait(100)
            if not inJob and jobActive then
                jobActive = false
                theJob = {}
            end

            RemoveEventHandler(evt)
        end)

        if not next(theJob) then
            theJob = {
                slot = math.random(1, #cfg.slots),
                removed = {},
                vehpos = vehSpawnPoint,
            }
        end

        vRP.subtitle("Iarba a ~g~crescut ~w~si trebuie tunsa, vezi harta pentru locatie.")

        if DoesEntityExist(mowerObj) then
            local x, y, z = GetEntityCoords(mowerObj)
            theJob.vehpos = {x, y, z}
        end

        TriggerServerEvent("jobs:updateLastJob", theJob)

        Citizen.CreateThread(function()
            local vehBlip

            while jobActive and not DoesEntityExist(mowerObj) do
                local ped = PlayerPedId()
                local pedPos = GetEntityCoords(ped)

                local vpos = vector3(table.unpack(theJob.vehpos))
                
                if not vehBlip then
                    vehBlip = AddBlipForCoord(vpos)
                    SetBlipSprite(vehBlip, 326)
                    SetBlipColour(vehBlip, 43)
                    SetBlipScale(vehBlip, 0.5)
                    SetBlipAsShortRange(vehBlip, true)
                    BeginTextCommandSetBlipName("STRING")
                    AddTextComponentString("Preluare vehicul")
                    EndTextCommandSetBlipName(vehBlip)
    
                    table.insert(blips, vehBlip)
                end

                if #(pedPos - vpos) <= 15 then
                    if not theJob.vehrot then
                        theJob.vehrot = 320.0
                    end
                    
                    getVehicleObject({pos = theJob.vehpos, h = theJob.vehrot, hash = `mower`, setinveh = true}, function(nveh)
                        mowerObj = nveh
                        TriggerServerEvent("jobs:setMowerObj", NetworkGetNetworkIdFromEntity(mowerObj))

                        RemoveBlip(vehBlip)

                        local blip = AddBlipForEntity(mowerObj)
                        SetBlipSprite(blip, 326)
                        SetBlipColour(blip, 43)
                        SetBlipScale(blip, 0.6)
                        SetBlipAsShortRange(blip, true)
                        BeginTextCommandSetBlipName("STRING")
                        AddTextComponentString("Masina de tuns iarba")
                        EndTextCommandSetBlipName(blip)
        
                        table.insert(blips, blip)
                    end)

                    Citizen.Wait(1000)

                    break
                end

                Citizen.Wait(1000)
            end
        end)


        Citizen.CreateThread(function()
            local inputActive = false

            local allGrass, spawnedGrass = {}, false

            local rocks = {}

            while jobActive do
                local ped = PlayerPedId()
                local pedPos = GetEntityCoords(ped)
                
                if theJob.slot then
                    local x, y, z = table.unpack(cfg.slots[theJob.slot][1])

                    if not blips.location then
                        local blip = AddBlipForCoord(x, y, z)
                        SetBlipSprite(blip, 1)
                        SetBlipScale(blip, 0.6)
                        SetBlipAsShortRange(blip, true)
                        BeginTextCommandSetBlipName("STRING")
                        AddTextComponentString("Zona cu iarba crescuta")
                        EndTextCommandSetBlipName(blip)
    
                        blips.location = blip
                    end

                    local blip = blips.location
                    SetBlipColour(blip, 82)
                    SetBlipCoords(blip, x, y, z)
                    SetBlipRoute(blip, true)
                    SetBlipRouteColour(blip, GetBlipColour(blip))

                    if not spawnedGrass then
                        local objHash = GetHashKey("prop_veg_grass_01_d")
                        RequestModel(objHash)
                        while not HasModelLoaded(objHash) do
                            Citizen.Wait(100)
                        end

                        local rockHash = GetHashKey("prop_rock_4_c")
                        RequestModel(rockHash)
                        while not HasModelLoaded(rockHash) do
                            Citizen.Wait(100)
                        end

                        for k, v in pairs(cfg.slots[theJob.slot]) do
                            local x, y, z = table.unpack(v)
                            if not theJob.removed[tostring(k)] then
                                local prop = CreateObject(objHash, x, y, z, false, true, false)
                                FreezeEntityPosition(prop, true)
                                SetEntityCollision(prop, false, false)

                                table.insert(allGrass, prop)
                                table.insert(objs, prop) -- safe remove
                            end
                        end

                        for k, v in pairs(cfg.rocksPos[theJob.slot]) do
                            local x, y, z = table.unpack(v)
                            local prop = CreateObject(rockHash, x, y, z, false, true, false)
                            FreezeEntityPosition(prop, true)

                            table.insert(rocks, prop)
                            table.insert(objs, prop) -- safe remove
                        end
                        spawnedGrass = true

                            
                        Citizen.CreateThread(function()
                            local input = false
                            local inMinigame = false
                            while jobActive and theJob.slot do

                                local pedPos = GetEntityCoords(PlayerPedId())

                                for _, rock in pairs(rocks) do
                                    while #(GetEntityCoords(rock) - pedPos) <= 2.5 do
                                        if not input then
                                            input = true
                                            TriggerEvent("vrp-hud:showBind", {key = "E", text = "Aduna piatra"})
                                        end

                                        if IsControlJustReleased(0, 38) and not IsPedInAnyVehicle(PlayerPedId(), true) and not inMinigame then
                                            TriggerEvent("vrp-hud:updateMap", false)
                                            TriggerEvent("vrp-hud:setComponentDisplay", {
                                                serverHud = false,
                                                minimapHud = false,
                                                bottomRightHud = false,
                                                chat = false,
                                            })

                                            inMinigame = true
                                            SendNUIMessage({job = "mowergame"})
                                            vRP.playAnim(false, {{"weapons@first_person@aim_rng@generic@projectile@thermal_charge@", "plant_floor"}}, true)
                                            gameFinish = function()
                                                TriggerEvent("vrp-hud:updateMap", true)
                                                TriggerEvent("vrp-hud:setComponentDisplay", {
                                                    serverHud = true,
                                                    minimapHud = true,
                                                    bottomRightHud = true,
                                                    chat = true,
                                                })
                                                inMinigame = false
                                                vRP.stopAnim(false)
                                                DeleteEntity(rock)
                                                TriggerServerEvent("work-lawnmower:getRock", cfg.rocksPos[theJob.slot])
                                            end
                                            break
                                        end

                                        pedPos = GetEntityCoords(PlayerPedId())
                                        Citizen.Wait(1)
                                    end

                                    if input then
                                        TriggerEvent("vrp-hud:showBind", false)
                                        input = false
                                    end
                                end
                                
                                Citizen.Wait(1000)
                            end
                        end)
                    end

                    while DoesEntityExist(mowerObj) and jobActive do
                       
                        for k, prop in pairs(allGrass) do
                            local pos = GetEntityCoords(prop)
                            local vpos = GetEntityCoords(mowerObj)

                            if DoesEntityExist(prop) and #(pos - vpos) <= 2.0 then
                                DeleteEntity(prop)
                                theJob.removed[tostring(k)] = true
                                allGrass[k] = nil
                                if DoesEntityExist(mowerObj) then
                                    local x, y, z = GetEntityCoords(mowerObj)
                                    theJob.vehpos = {x, y, z}
                                end
                                TriggerServerEvent("jobs:updateLastJob", theJob)
                                Citizen.Wait(500)
                            end
                        end

                        if not next(allGrass) then
                            triggerCallback("getPaid", function()
                                theJob = {}
                                TriggerServerEvent("jobs:updateLastJob", false)
                                vRP.subtitle("~g~Minunat! ~w~Ai terminat de tuns iarba, asteapta urmatoarea zona.")
                            end, cpData)
                            break
                        end


                        ped = PlayerPedId()
                        pedPos = GetEntityCoords(ped)
                        Citizen.Wait(1)
                    end

                elseif next(blips) then
                    for _, blipid in pairs(blips) do
                        RemoveBlip(blipid)
                    end
                    blips = {}
                end
                
                if not theJob.slot then
                    jobActive = false
                end
                
                Citizen.Wait(2000)
            end
            
            if next(blips) then
                for _, blipid in pairs(blips) do
                    RemoveBlip(blipid)
                end
                blips = {}
            end

            for k, object in pairs(objs) do
                DeleteEntity(object)
            end
            objs = {}
        end)
    end
end)

AddEventHandler("jobs:setLastJob", function(job, lastJob)
    if job == "Taietor de iarba" then
        theJob = lastJob
    end
end)

local resName = GetCurrentResourceName()
AddEventHandler("onResourceStop", function(res)
    if res == resName then
        for k, object in pairs(objs) do
            DeleteEntity(object)
        end
        objs = {}
    end
end)

